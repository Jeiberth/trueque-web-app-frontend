import{_ as C,b as U,r as m,x as v,d as x,K as D,G as N,L as b,c as i,h as L,i as R,a as n,F as _,p as S,e as w,O as A,I as H,v as K,t as l,k as O,m as q,o as c,n as F,N as T,l as G}from"./index-0guTc2cZ.js";import{f as V}from"./fallback_thing_msg-BHafCOoy.js";const $={class:"message-container"},j={class:"messages"},z={class:"date-separator"},Y={class:"message-content"},J={key:0,class:"barter-item"},P=["src","alt"],Q={class:"item-text"},W={key:1,style:{width:"100%"}},X={class:"messageTextContent"},Z={class:"date"},ee={class:"input-container"},te=["placeholder"],se={class:"sendButtonText"},ae={__name:"messagesChat",setup(oe){function k(e){e.target.src=V}const{t:h}=U(),u=m(""),r=O(),g=r.getters.getUserId,E=m(!1),d=q().query.chatId,p=m(!1),M=e=>{const s=new Date;s.setHours(0,0,0,0);const t=new Date(e);t.setHours(0,0,0,0);const o=new Date(s);o.setDate(o.getDate()-1);const a=Math.round((s-t)/(1e3*60*60*24));return a===0?h("Today"):a===1?h("Yesterday"):t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})},I=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),y=v(()=>(r.getters.getMessagesByChatId(d)||[]).filter(s=>s._status!=="failed")),B=v(()=>{const e={};return[...y.value].sort((t,o)=>new Date(t.created_at)-new Date(o.created_at)).forEach(t=>{const o=new Date(t.created_at).toDateString();e[o]||(e[o]={date:o,displayDate:M(t.created_at),messages:[]}),e[o].messages.push(t)}),Object.values(e)}),f=async()=>{const e=u.value.trim();if(e)try{u.value="",await r.dispatch("sendNewMessage",{chatId:d,content:e})}catch(s){console.error("Failed to send message:",s)}};return x(async()=>{try{r.commit("RESET_UNREAD_MESSAGES_COUNT",d),r.commit("setLoading",!0),await r.dispatch("fetchMessages",d),await r.dispatch("markMessagesRead",d),D(()=>{const e=document.querySelector(".messages");e==null||e.scrollTo({top:e.scrollHeight})})}finally{r.commit("setLoading",!1)}p.value=!0}),N(()=>{r.commit("RESET_UNREAD_MESSAGES_COUNT",d)}),b(y,()=>{D(()=>{const e=document.querySelector(".messages");e==null||e.scrollTo({top:e.scrollHeight})})},{deep:!0}),(e,s)=>(c(),i("div",$,[E.value?(c(),L(G,{key:0})):R("",!0),n("div",j,[(c(!0),i(_,null,S(B.value,(t,o)=>(c(),i(_,{key:o},[n("div",z,l(t.displayDate),1),(c(!0),i(_,null,S(t.messages,a=>(c(),i("div",{key:a.id,class:F(["message",{sent:a.user_id===T(g),received:a.user_id!==T(g)}])},[n("div",Y,[a.thing?(c(),i("div",J,[n("img",{src:a.thing.imagesUrl,alt:a.thing.name,class:"item-image",onError:k},null,40,P),n("p",Q,l(e.$t("Hey! I like your "))+l(a.thing.name)+"!",1)])):(c(),i("div",W,[n("p",X,l(a.content),1)])),n("span",Z,l(I(a.created_at)),1)])],2))),128))],64))),128))]),w(n("div",ee,[w(n("input",{"onUpdate:modelValue":s[0]||(s[0]=t=>u.value=t),type:"text",placeholder:e.$t("Type your message..."),class:"inputText",onKeypress:H(f,["enter"])},null,40,te),[[K,u.value]]),n("button",{onClick:f,class:"sendButton"},[n("div",se,l(e.$t("Send")),1)])],512),[[A,p.value]])]))}},ie=C(ae,[["__scopeId","data-v-e8b9672f"]]);export{ie as default};
